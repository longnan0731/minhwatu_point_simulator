<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>ë¯¼í™”íˆ¬ ì ìˆ˜ ì‹œë®¬ë ˆì´í„° v4 (í’€ì˜µì…˜)</title>
<style>
:root{--accent:#ff9500;--accent-dark:#e07a00;--good:#017a3b;--bad:#cc0000}
*{box-sizing:border-box}
body{font-family:Inter,"Noto Sans KR",system-ui,Segoe UI,Roboto,Arial;background:#fff8f0;margin:0;padding:16px;display:flex;flex-direction:column;align-items:center;gap:12px;color:#222}
h1{margin:0;color:var(--accent);font-size:1.25rem}
.wrap{width:100%;max-width:920px;display:grid;grid-template-columns:1fr 420px;gap:12px}
@media(max-width:980px){.wrap{grid-template-columns:1fr}}
.panel{background:#fff;border-radius:12px;padding:12px;box-shadow:0 6px 20px rgba(20,30,60,0.06)}
.players{display:flex;flex-direction:column;gap:10px}
.player{border-radius:10px;padding:10px;background:#fbfbfb;border:1px solid #eee;display:flex;gap:8px;align-items:flex-start;flex-wrap:wrap}
.player .left{width:120px;min-width:110px}
.player h3{margin:0;font-size:1rem;color:var(--accent)}
input[type="text"]{width:100%;padding:6px;border-radius:8px;border:1px solid #ddd}
input[type="number"]{width:68px;padding:6px;border-radius:8px;border:1px solid #ddd;text-align:center}
.group{display:flex;gap:8px;flex-wrap:wrap}
.chk{display:flex;align-items:center;gap:6px}
.chk input{width:18px;height:18px}
.highlight-on{background:#fff2df;border-color:var(--accent)!important;box-shadow:0 0 8px rgba(255,149,0,0.18)}
button{background:var(--accent);border:none;color:#fff;padding:10px 12px;border-radius:10px;font-weight:700;cursor:pointer}
button.secondary{background:#6b6b6b}
#controls{display:flex;gap:8px;flex-wrap:wrap}
#result{min-height:60px}
.res-line{padding:8px;border-radius:8px;margin-bottom:8px;background:#fffef6;border:1px solid #f3f0d8}
.gain{color:var(--good);font-weight:700;animation:rise 700ms ease}
.loss{color:var(--bad);font-weight:700;animation:fall 700ms ease}
.small{font-size:0.92rem;color:#555}
.detail{font-size:0.9rem;color:#444;margin-top:4px}
.history-list{max-height:260px;overflow:auto;padding:6px;display:flex;flex-direction:column;gap:6px}
.turn-card{padding:8px;border-radius:8px;background:#fffefc;border:1px solid #eee}
canvas{width:100%;height:160px;background:#fff;border-radius:8px}
.flex{display:flex;gap:8px;align-items:center}
.muted{color:#666;font-size:0.9rem}
.export-area{width:100%;min-height:80px;border:1px dashed #ddd;padding:8px;border-radius:8px;background:#fff}

/* ë‚´ë¶€ ì „ìš© íŒì—… */
.popup-overlay{position:fixed;inset:0;background:rgba(0,0,0,0.4);display:flex;justify-content:center;align-items:center;z-index:999}
.popup-box{background:#fff;padding:20px;border-radius:12px;max-width:320px;width:80%;text-align:center;box-shadow:0 8px 24px rgba(0,0,0,0.2)}
.popup-box p{margin:0 0 16px;font-size:1rem;color:#333}
.popup-btns{display:flex;justify-content:center;gap:10px}
.popup-btns button{flex:1}
</style>
</head>
<body>
<h1>ë¯¼í™”íˆ¬ ì ìˆ˜ ì‹œë®¬ë ˆì´í„° v4 ğŸ´ (í’€ì˜µì…˜)</h1>

<div class="wrap">
  <!-- LEFT -->
  <div class="panel">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
      <div class="small">4ì¸ ê³ ì • / ì´ë¦„ ë³€ê²½ ê°€ëŠ¥ / í„´ë³„ ëˆ„ì Â·ë¡œê·¸Â·ë¡œì»¬ì €ì¥</div>
      <div class="small muted">ë£°: ê´‘Ã—20, ì—´ë—Ã—10, ì˜¤ë—Ã—5 / ë¹„Â·í’Â·ì´ˆ ì•½ 20 / ì²­Â·í™Â·ì´ˆ ë‹¨ 30 / ì˜¤ë™ì•½ 40</div>
    </div>
    <div class="players" id="playersContainer"></div>
    <div id="controls" style="margin-top:10px">
      <button id="btnCalc">ì´ë²ˆ í„´ ì ìˆ˜ ê³„ì‚°</button>
      <button id="btnSave" class="secondary">ì €ì¥</button>
      <button id="btnLoad" class="secondary">ë¶ˆëŸ¬ì˜¤ê¸°</button>
      <button id="btnExport" class="secondary">ë‚´ë³´ë‚´ê¸°</button>
      <button id="btnImport" class="secondary">ë¶ˆëŸ¬ì˜¤ê¸°(JSON)</button>
      <button id="btnReset" class="secondary">ì „ì²´ ì´ˆê¸°í™”</button>
    </div>
    <div style="margin-top:10px" class="small muted">- ìë™ ì €ì¥: ê° í„´ ê³„ì‚° í›„ ìë™ìœ¼ë¡œ localStorageì— ì €ì¥ë©ë‹ˆë‹¤.</div>
    <div id="result" style="margin-top:12px" class="panel"></div>
  </div>

  <!-- RIGHT -->
  <div style="display:flex;flex-direction:column;gap:12px">
    <div class="panel" style="padding:10px">
      <div style="display:flex;justify-content:space-between;align-items:center">
        <div><strong>ğŸ“œ í„´ë³„ ë¡œê·¸ / ëˆ„ì  ì ìˆ˜</strong></div>
        <div class="muted small">í„´: <span id="turnLabel">1</span></div>
      </div>
      <div class="history-list" id="historyList"></div>
    </div>

    <div class="panel" style="padding:10px">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px">
        <div><strong>ğŸ† í˜„ì¬ ì ìˆ˜ & ë­í‚¹</strong></div>
        <div class="small muted">ì‹¤ì‹œê°„ ê·¸ë˜í”„</div>
      </div>
      <canvas id="scoreChart"></canvas>
      <div id="ranking" style="margin-top:8px" class="small"></div>
    </div>

    <div class="panel">
      <strong>ë°ì´í„° ë‚´ë³´ë‚´ê¸° / ë¶ˆëŸ¬ì˜¤ê¸°</strong>
      <textarea id="exportArea" class="export-area" placeholder="ì—¬ê¸°ì— JSON ë¶™ì—¬ë„£ê¸° í›„ ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ì„ ëˆ„ë¥´ì„¸ìš”"></textarea>
    </div>
  </div>
</div>

<script>
const POINTS={gwang:20,yeol:10,ok:5,yak:20,dan:30,odong:40};
const PLAYER_COUNT=4;
const STORAGE_KEY='minhwatu_v3_state';
let state={turn:1,players:[{name:'A',total:0},{name:'B',total:0},{name:'C',total:0},{name:'D',total:0}],logs:[]};

function escapeHtml(str){return String(str).replace(/[&<>"']/g,s=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[s]));}

function renderPlayerInputs(){
  const container=document.getElementById('playersContainer');
  container.innerHTML='';
  for(let i=0;i<PLAYER_COUNT;i++){
    const p=state.players[i];
    const div=document.createElement('div');
    div.className='player';
    div.innerHTML=`
      <div class="left">
        <h3><input id="name_${i}" type="text" value="${escapeHtml(p.name)}" /></h3>
        <div class="small muted">ëˆ„ì : <span id="total_${i}">${p.total}</span> ì </div>
      </div>
      <div style="flex:1;">
        <div style="display:flex;gap:8px;flex-wrap:wrap">
          <label class="small">ê´‘ <input id="gwang_${i}" type="number" min="0" value="0"></label>
          <label class="small">ì—´ë— <input id="yeol_${i}" type="number" min="0" value="0"></label>
          <label class="small">ì˜¤ë— <input id="ok_${i}" type="number" min="0" value="0"></label>
        </div>
        <div style="margin-top:8px" class="small">ì•½</div>
        <div class="group" style="margin-top:6px">
          <label class="chk"><input id="biyak_${i}" type="checkbox"> ë¹„ì•½</label>
          <label class="chk"><input id="pungyak_${i}" type="checkbox"> í’ì•½</label>
          <label class="chk"><input id="choyak_${i}" type="checkbox"> ì´ˆì•½</label>
          <label class="chk"><input id="odong_${i}" type="checkbox"> ì˜¤ë™ì•½</label>
        </div>
        <div style="margin-top:8px" class="small">ë‹¨</div>
        <div class="group" style="margin-top:6px">
          <label class="chk"><input id="cheongdan_${i}" type="checkbox"> ì²­ë‹¨</label>
          <label class="chk"><input id="hongdan_${i}" type="checkbox"> í™ë‹¨</label>
          <label class="chk"><input id="chodan_${i}" type="checkbox"> ì´ˆë‹¨</label>
        </div>
      </div>`;
    container.appendChild(div);
  }
}
renderPlayerInputs();

/* ----- ì ìˆ˜ ê³„ì‚° ----- */
function calculateTurn(){
  const names=[],base=[],yakdan=[];
  for(let i=0;i<PLAYER_COUNT;i++){
    names[i]=document.getElementById(`name_${i}`).value||('P'+(i+1));
    const gw=+document.getElementById(`gwang_${i}`).value||0;
    const ye=+document.getElementById(`yeol_${i}`).value||0;
    const ok=+document.getElementById(`ok_${i}`).value||0;
    base[i]=gw*POINTS.gwang+ye*POINTS.yeol+ok*POINTS.ok;
    let y=0;
    if(document.getElementById(`biyak_${i}`).checked)y+=POINTS.yak;
    if(document.getElementById(`pungyak_${i}`).checked)y+=POINTS.yak;
    if(document.getElementById(`choyak_${i}`).checked)y+=POINTS.yak;
    if(document.getElementById(`odong_${i}`).checked)y+=POINTS.odong;
    if(document.getElementById(`cheongdan_${i}`).checked)y+=POINTS.dan;
    if(document.getElementById(`hongdan_${i}`).checked)y+=POINTS.dan;
    if(document.getElementById(`chodan_${i}`).checked)y+=POINTS.dan;
    yakdan[i]=y;
  }
  const changes=Array(PLAYER_COUNT).fill(0);
  const lossesDetail=Array.from({length:PLAYER_COUNT},()=>[]);
  for(let i=0;i<PLAYER_COUNT;i++){
    if(yakdan[i]===0)continue;
    const gain=yakdan[i]*(PLAYER_COUNT-1);
    changes[i]+=gain;
    for(let j=0;j<PLAYER_COUNT;j++){if(i===j)continue;changes[j]-=yakdan[i];lossesDetail[j].push({from:names[i],amount:yakdan[i]});}
  }
  const entries=[];
  for(let i=0;i<PLAYER_COUNT;i++){const turnTotal=base[i]+changes[i];entries.push({name:names[i],base:base[i],yakdan:yakdan[i],gain:(yakdan[i]?yakdan[i]*(PLAYER_COUNT-1):0),losses:lossesDetail[i],turnTotal});}
  for(let i=0;i<PLAYER_COUNT;i++)state.players[i].total+=entries[i].turnTotal;
  const log={turn:state.turn,timestamp:Date.now(),entries,snapshotTotals:state.players.map(p=>p.total)};
  state.logs.push(log);state.turn++;autoSave();renderResultFromLog(log);renderHistory();renderTotals();renderChart();
}

/* ----- ë Œë” ----- */
function renderResultFromLog(log){
  const el=document.getElementById('result');
  let html=`<div class="res-line"><strong>ğŸ¯ í„´ ${log.turn} ê³„ì‚° ê²°ê³¼</strong></div>`;
  log.entries.forEach(e=>{
    const sign=e.turnTotal>=0?'+':'';
    const cls=e.turnTotal>=0?'gain':'loss';
    let detail=`ê¸°ë³¸ ${e.base}ì `;
    if(e.yakdan>0)detail+=` + (ì•½Â·ë‹¨ ${e.yakdan}ì  Ã—3 = ${e.gain}ì )`;
    if(e.losses.length>0)detail+=`<div class="detail" style="color:#cc0000">ê°ì : `+e.losses.map(l=>`-${l.amount} (${escapeHtml(l.from)})`).join(', ')+'</div>';
    html+=`<div class="res-line ${cls}"><strong>${escapeHtml(e.name)}</strong>: ${sign}${e.turnTotal}ì  <div class="small">${detail}</div></div>`;
  });
  el.innerHTML=html;
  document.getElementById('turnLabel').textContent=state.turn;
}

function renderHistory(){
  const list=document.getElementById('historyList');list.innerHTML='';
  for(let i=state.logs.length-1;i>=0;i--){
    const lg=state.logs[i];const card=document.createElement('div');card.className='turn-card';
    let inner=`<div><strong>í„´ ${lg.turn}</strong></div>`;
    lg.entries.forEach(e=>{inner+=`<div class="small">${escapeHtml(e.name)}: ${e.turnTotal>=0?'+':''}${e.turnTotal}</div>`});
    card.innerHTML=inner;list.appendChild(card);
  }
}
function renderTotals(){for(let i=0;i<PLAYER_COUNT;i++)document.getElementById(`total_${i}`).textContent=state.players[i].total;}
function renderChart(){
  const canvas=document.getElementById('scoreChart'),ctx=canvas.getContext('2d');
  const DPR=window.devicePixelRatio||1,W=canvas.clientWidth,H=canvas.clientHeight;
  canvas.width=W*DPR;canvas.height=H*DPR;ctx.scale(DPR,DPR);ctx.clearRect(0,0,W,H);
  const arr=state.players.map(p=>({name:p.name,total:p.total}));const max=Math.max(60,...arr.map(a=>Math.abs(a.total))),barW=(W-40)/PLAYER_COUNT;
  arr.forEach((a,i)=>{const x=20+i*barW;const barH=Math.abs(a.total)/max*(H-40);const y=a.total>=0?(H-20-barH):(H-20);
    ctx.fillStyle=a.total>=0?'#b7f0c9':'#ffd6d6';ctx.fillRect(x,y,barW*0.7,barH);
    ctx.fillStyle='#333';ctx.font='14px sans-serif';ctx.fillText(a.name,x,H-2);ctx.fillText(a.total+'ì ',x,y-6);
  });
}

/* ----- ì €ì¥/ë¶ˆëŸ¬ì˜¤ê¸° ----- */
function autoSave(){try{localStorage.setItem(STORAGE_KEY,JSON.stringify(state));}catch(e){}}
function manualSave(){autoSave();customAlert('ê²Œì„ ìƒíƒœë¥¼ ì €ì¥í–ˆìŠµë‹ˆë‹¤.');}
function manualLoad(){const raw=localStorage.getItem(STORAGE_KEY);if(!raw){customAlert('ì €ì¥ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');return;}try{state=JSON.parse(raw);renderAllAfterLoad();customAlert('ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');}catch(e){customAlert('ë¶ˆëŸ¬ì˜¤ê¸° ì‹¤íŒ¨');}}
function exportJSON(){document.getElementById('exportArea').value=JSON.stringify(state,null,2);customAlert('JSONì´ ì±„ì›Œì¡ŒìŠµë‹ˆë‹¤.');}
function importJSON(){const raw=document.getElementById('exportArea').value.trim();if(!raw){customAlert('JSONì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');return;}try{state=JSON.parse(raw);renderAllAfterLoad();autoSave();customAlert('ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');}catch(e){customAlert('JSON ì˜¤ë¥˜');}}

/* ì „ì²´ ì´ˆê¸°í™” */
function resetAll(){
  customConfirm('ì •ë§ ì „ì²´ ì´ˆê¸°í™”(ëˆ„ì  ì ìˆ˜, ë¡œê·¸ ëª¨ë‘ ì‚­ì œ) í•˜ì‹œê² ìŠµë‹ˆê¹Œ?',()=>{
    state={turn:1,players:[{name:'A',total:0},{name:'B',total:0},{name:'C',total:0},{name:'D',total:0}],logs:[]};
    renderPlayerInputs();renderTotals();renderHistory();renderChart();
    document.getElementById('result').innerHTML='';autoSave();customAlert('âœ… ì „ì²´ ì´ˆê¸°í™” ì™„ë£Œ!');
  });
}
function renderAllAfterLoad(){renderPlayerInputs();renderTotals();renderHistory();renderChart();document.getElementById('turnLabel').textContent=state.turn;document.getElementById('result').innerHTML='';}

/* ë‚´ë¶€ ì „ìš© íŒì—… */
function customAlert(msg){const overlay=document.createElement('div');overlay.className='popup-overlay';
overlay.innerHTML=`<div class="popup-box"><p>${msg}</p><div class="popup-btns"><button>í™•ì¸</button></div></div>`;document.body.appendChild(overlay);overlay.querySelector('button').onclick=()=>overlay.remove();}
function customConfirm(msg,onYes){const overlay=document.createElement('div');overlay.className='popup-overlay';
overlay.innerHTML=`<div class="popup-box"><p>${msg}</p><div class="popup-btns"><button id="yesBtn">í™•ì¸</button><button class="secondary" id="noBtn">ì·¨ì†Œ</button></div></div>`;document.body.appendChild(overlay);
overlay.querySelector('#yesBtn').onclick=()=>{overlay.remove();onYes&&onYes();};overlay.querySelector('#noBtn').onclick=()=>overlay.remove();}

/* ì´ë²¤íŠ¸ ì—°ê²° */
document.getElementById('btnCalc').onclick=calculateTurn;
document.getElementById('btnSave').onclick=manualSave;
document.getElementById('btnLoad').onclick=manualLoad;
document.getElementById('btnExport').onclick=exportJSON;
document.getElementById('btnImport').onclick=importJSON;
document.getElementById('btnReset').onclick=resetAll;

/* ì´ˆê¸° ë¡œë“œ ì‹œ localStorage ë¶ˆëŸ¬ì˜¤ê¸° */
window.addEventListener('load',()=>{const raw=localStorage.getItem(STORAGE_KEY);if(raw){try{state=JSON.parse(raw);}catch(e){}}
renderAllAfterLoad();});
</script>
</body>
</html>
